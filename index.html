<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Starcup Applaudim√®tre</title>
  <style>
    :root{
      --bgA:#05040c;
      --bgB:#12022a;

      --glass: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.18);

      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.74);

      --shadow: 0 24px 100px rgba(0,0,0,.60);

      --neonBlue: #00d5ff;
      --neonViolet:#7c3cff;
      --neonPink:#ff2bd6;
      --neonHot:#ff4d6d;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); }
    body{
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 20% 25%, rgba(0,213,255,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 25%, rgba(255,43,214,.20), transparent 60%),
        radial-gradient(900px 650px at 50% 90%, rgba(124,60,255,.20), transparent 60%),
        linear-gradient(160deg, var(--bgA), var(--bgB));
    }

    .spot{
      position:absolute; inset:-45vmax;
      background: conic-gradient(from 0deg, rgba(255,255,255,0), rgba(255,255,255,.08), rgba(255,255,255,0));
      filter: blur(55px);
      animation: spin 20s linear infinite;
      opacity:.45;
      pointer-events:none;
    }
    .spot.two{ animation-duration: 32s; opacity:.30; transform: scale(1.10); }
    @keyframes spin { to { transform: rotate(360deg); } }

    .wrap{
      position:relative;
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr auto;
      padding: 22px;
      gap: 14px;
      z-index: 1;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:12px; align-items:baseline; flex-wrap:wrap;
    }
    .title{
      font-size: clamp(22px, 2.8vw, 36px);
      font-weight: 1000;
      letter-spacing:.02em;
      text-shadow: 0 0 22px rgba(0,213,255,.18);
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 15px;
      cursor:pointer;
      box-shadow: 0 10px 28px rgba(0,0,0,.30);
      transition: transform .08s ease, filter .12s ease, background .2s ease;
    }
    button:hover{ filter: brightness(1.12); }
    button:active{ transform: scale(.98); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .sliderWrap{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    input[type="range"]{
      width: 240px;
      accent-color: var(--neonPink);
    }

    .main{ display:grid; place-items:center; overflow:auto; }
    .card{
      width: min(1350px, 96vw);
      padding: clamp(16px, 2.0vw, 26px);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .teamsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .teamsGrid{ grid-template-columns: 1fr; }
      input[type="range"]{ width: 200px; }
    }

    .team{
      padding: 16px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
    }
    .teamHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap:wrap;
    }
    .teamName{
      font-size: clamp(18px, 2.2vw, 28px);
      font-weight: 1000;
      letter-spacing: .01em;
    }
    .teamTag{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      font-weight: 850;
      font-size: 13px;
      white-space: nowrap;
    }

    .nameRow{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .nameInput{
      flex:1;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.95);
      font-weight: 800;
      outline: none;
    }
    .nameInput::placeholder{ color: rgba(255,255,255,.55); }

    .meter{
      height: 115px;
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .meter::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg,
        rgba(0,213,255,1) 0%,
        rgba(124,60,255,1) 55%,
        rgba(255,43,214,1) 100%);
      opacity:.16;
    }
    .fill{
      position:absolute; inset:0 auto 0 0;
      width:0%;
      background: linear-gradient(90deg,
        rgba(0,213,255,1) 0%,
        rgba(124,60,255,1) 55%,
        rgba(255,43,214,1) 100%);
      filter:
        drop-shadow(0 0 24px rgba(0,213,255,.18))
        drop-shadow(0 0 24px rgba(255,43,214,.14));
      transition: width 40ms linear;
    }
    .scanline{
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.06) 0px,
        rgba(255,255,255,.06) 1px,
        rgba(255,255,255,0) 3px,
        rgba(255,255,255,0) 7px
      );
      opacity:.10;
      pointer-events:none;
    }
    .shine{
      position:absolute; top:-45%; left:-30%;
      width: 38%; height: 190%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.26), transparent);
      transform: skewX(-18deg);
      opacity:.55;
      animation: sweep 2.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes sweep{
      0%{ left:-38%; opacity:.0; }
      18%{ opacity:.60; }
      62%{ opacity:.60; }
      100%{ left:115%; opacity:.0; }
    }

    .bigScore{
      margin-top: 12px;
      font-size: clamp(52px, 6.8vw, 98px);
      font-weight: 1050;
      line-height: 1;
      letter-spacing: .01em;
      text-shadow: 0 0 26px rgba(255,43,214,.18);
    }

    .miniRow{
      margin-top: 10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }
    .pill{
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      white-space: nowrap;
    }

    .bottomRow{
      margin-top: 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .winner{
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .winner strong{ font-size: clamp(18px, 2vw, 22px); }
    .winner span{ color: var(--muted); font-weight: 850; }

    /* Overlay: plus opaque (tu demandais) */
    .overlay{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.90); /* ‚Üê opacit√© forte */
      z-index: 10;
      padding: 18px;
    }
    .overlay.show{ display:grid; }

    .overlayBox{
      width: min(1200px, 92vw);
      padding: clamp(18px, 3vw, 34px);
      border-radius: 28px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 30px 110px rgba(0,0,0,.65);
      text-align:center;
    }
    .overlayTitle{
      font-weight: 1000;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: clamp(18px, 2.1vw, 28px);
      color: rgba(255,255,255,.90);
    }
    .overlayTeam{
      margin-top: 10px;
      font-weight: 1050;
      font-size: clamp(22px, 2.6vw, 34px);
      color: rgba(255,255,255,.92);
      text-shadow: 0 0 24px rgba(0,213,255,.18);
    }
    .overlayBig{
      margin-top: 10px;
      font-weight: 1100;
      font-size: min(18vw, 200px);
      line-height: 1;
      letter-spacing: .02em;
      text-shadow:
        0 0 30px rgba(0,213,255,.20),
        0 0 30px rgba(255,43,214,.18);
    }
    .overlaySub{
      margin-top: 8px;
      font-size: clamp(16px, 2.0vw, 24px);
      color: rgba(255,255,255,.78);
      font-weight: 900;
    }
    .overlayMeter{
      margin-top: 18px;
      height: 110px;
      border-radius: 22px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.18);
      overflow:hidden;
      position:relative;
    }
    .overlayFill{
      position:absolute; inset:0 auto 0 0;
      width:0%;
      background: linear-gradient(90deg,
        rgba(0,213,255,1) 0%,
        rgba(124,60,255,1) 55%,
        rgba(255,43,214,1) 100%);
      filter:
        drop-shadow(0 0 28px rgba(0,213,255,.22))
        drop-shadow(0 0 28px rgba(255,43,214,.20));
      transition: width 30ms linear;
    }
    .overlayGrid{
      position:absolute; inset:0;
      background: linear-gradient(90deg,
        rgba(255,255,255,.10) 1px, transparent 1px);
      background-size: 10% 100%;
      opacity:.12;
      pointer-events:none;
    }

    canvas#confetti{
      position:absolute; inset:0;
      pointer-events:none;
      z-index: 9;
    }

    .footer{
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 13px;
      opacity:.92;
    }

    .hint{
      color: rgba(255,255,255,.78);
      font-weight: 850;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="spot"></div>
  <div class="spot two"></div>
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="title">Starcup Applaudim√®tre</div>
        <div class="badge">Compte √† rebours ¬∑ Mesure 5s ¬∑ Score final</div>
      </div>

      <div class="controls">
        <button id="calibBtn">Calibrer (2s calme)</button>

        <div class="sliderWrap">
          <span class="badge">Sensibilit√©</span>
          <input id="sens" type="range" min="80" max="900" value="320" />
          <span class="badge">Max: <span id="maxv">320</span></span>
        </div>

        <button id="addTeamBtn">+ Ajouter une √©quipe</button>
        <button id="fullscreenBtn">Plein √©cran</button>
        <button id="stopBtn" disabled>Stop micro</button>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="teamsGrid" id="teamsGrid"></div>

        <div class="bottomRow">
          <div class="hint">Renomme les √©quipes si besoin, puis lance-les une par une (bouton ‚ÄúLancer‚Äù).</div>
          <div class="hint">Conseil : micro loin des enceintes. Calibrer quand la salle est stable.</div>
        </div>

        <div class="winner" style="margin-top:16px;">
          <div>
            <strong>R√©sultat :</strong>
            <span id="resultText">Pr√™t ‚Äî lance une √©quipe.</span>
          </div>
          <div>
            <span class="pill">Bruit (calme): <span id="noise">0</span></span>
            <span class="pill">√âtat: <span id="state">Pr√™t</span></span>
          </div>
        </div>
      </div>

      <div class="overlay" id="overlay">
        <div class="overlayBox">
          <div class="overlayTitle" id="ovTitle">Pr√©parez-vous</div>
          <div class="overlayTeam" id="ovTeam">√âquipe</div>
          <div class="overlayBig" id="ovBig">3</div>
          <div class="overlaySub" id="ovSub">‚Ä¶</div>

          <div class="overlayMeter" aria-label="Jauge live">
            <div class="overlayFill" id="ovFill"></div>
            <div class="overlayGrid"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Web Audio API ¬∑ Micro navigateur ¬∑ Full front (GitHub Pages recommand√©)</div>
      <div>Astuce: si 100 arrive trop vite, augmente ‚ÄúMax‚Äù.</div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const COUNTDOWN_SECONDS = 3;
const MEASURE_SECONDS = 5.0;

/* ========= DOM ========= */
const teamsGrid = document.getElementById('teamsGrid');
const calibBtn = document.getElementById('calibBtn');
const addTeamBtn = document.getElementById('addTeamBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const stopBtn = document.getElementById('stopBtn');

const resultText = document.getElementById('resultText');
const noiseEl = document.getElementById('noise');
const stateEl = document.getElementById('state');

const overlay = document.getElementById('overlay');
const ovTitle = document.getElementById('ovTitle');
const ovTeam  = document.getElementById('ovTeam');
const ovBig   = document.getElementById('ovBig');
const ovSub   = document.getElementById('ovSub');
const ovFill  = document.getElementById('ovFill');

const sens = document.getElementById('sens');
const maxvEl = document.getElementById('maxv');
let maxLevel = Number(sens.value);
maxvEl.textContent = String(maxLevel);
sens.addEventListener('input', () => {
  maxLevel = Number(sens.value);
  maxvEl.textContent = String(maxLevel);
});

/* ========= AUDIO ========= */
let audioCtx, analyser, data, src, stream;
let running = false;
let noiseFloor = 0;

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function rmsFromTimeDomain(byteArray) {
  let sum = 0;
  for (let i = 0; i < byteArray.length; i++) {
    const v = (byteArray[i] - 128) / 128;
    sum += v * v;
  }
  return Math.sqrt(sum / byteArray.length);
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }

async function startAudio() {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  data = new Uint8Array(analyser.fftSize);
  src = audioCtx.createMediaStreamSource(stream);
  src.connect(analyser);

  running = true;
  stopBtn.disabled = false;
  stateEl.textContent = "Micro OK";
}

function stopAudio() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  if (audioCtx) audioCtx.close();
  audioCtx = null;
  running = false;
  stopBtn.disabled = true;
  stateEl.textContent = "Arr√™t√©";
}

function levelNow() {
  analyser.getByteTimeDomainData(data);
  const rms = rmsFromTimeDomain(data);
  return Math.round(rms * 1000);
}

/* ========= UI helpers ========= */
function setBar(el, pct){
  pct = Math.max(0, Math.min(100, pct));
  el.style.width = pct + "%";
}
function showOverlay(){ overlay.classList.add('show'); }
function hideOverlay(){ overlay.classList.remove('show'); }

function lockRunButtons(isLocked){
  document.querySelectorAll('[data-run]').forEach(b => b.disabled = isLocked);
  addTeamBtn.disabled = isLocked;
  calibBtn.disabled = isLocked;
}

/* ========= CALIB ========= */
async function calibrate2s() {
  if (!running) await startAudio();

  stateEl.textContent = "Calibration‚Ä¶";
  ovTitle.textContent = "Calibration";
  ovTeam.textContent = "Silence 2 secondes";
  ovBig.textContent = "‚Ä¶";
  ovSub.textContent = "On mesure le bruit ambiant";
  setBar(ovFill, 0);
  showOverlay();

  let t0 = performance.now();
  let acc = 0, n = 0;
  while (performance.now() - t0 < 2000) {
    acc += levelNow();
    n++;
    await sleep(30);
  }
  noiseFloor = Math.round(acc / Math.max(1, n));
  noiseEl.textContent = String(noiseFloor);

  ovBig.textContent = "OK";
  ovSub.textContent = `Bruit mesur√©: ${noiseFloor}`;
  await sleep(650);
  hideOverlay();

  stateEl.textContent = "Calibr√©";
}

/* ========= COUNTDOWN + MEASURE ========= */
async function countdown(teamLabel){
  showOverlay();
  ovTitle.textContent = "Pr√©parez-vous";
  ovTeam.textContent = teamLabel;
  ovSub.textContent = "On d√©marre dans‚Ä¶";
  setBar(ovFill, 0);

  for (let n = COUNTDOWN_SECONDS; n >= 1; n--) {
    ovBig.textContent = String(n);
    await sleep(800);
  }
  ovBig.textContent = "GO!";
  ovTitle.textContent = "FAITES DU BRUIT !";
  ovSub.textContent = `Mesure pendant ${MEASURE_SECONDS.toFixed(0)} secondes`;
  await sleep(420);
}

async function measureLive(fillEl){
  let t0 = performance.now();

  let accEff = 0;
  let peakEff = 0;
  let samples = 0;

  let smooth = 0;

  while ((performance.now() - t0) < MEASURE_SECONDS * 1000) {
    const raw = levelNow();
    const eff = Math.max(0, raw - noiseFloor);

    accEff += eff;
    peakEff = Math.max(peakEff, eff);
    samples++;

    const t = clamp01(eff / maxLevel);
    smooth = smooth * 0.80 + t * 0.20;

    const livePct = Math.round(smooth * 100);
    setBar(fillEl, livePct);
    setBar(ovFill, livePct);

    const elapsed = (performance.now() - t0) / 1000;
    const secondsLeft = Math.max(0, MEASURE_SECONDS - elapsed);
    ovBig.textContent = String(livePct);
    ovSub.textContent = `Explosez la jauge ! ${secondsLeft.toFixed(1)}s`;

    await sleep(20);
  }

  const avgEff = accEff / Math.max(1, samples);
  const combined = (avgEff * 0.75) + (peakEff * 0.25);
  const score = Math.round(clamp01(combined / maxLevel) * 100);

  setBar(fillEl, score);
  setBar(ovFill, score);
  ovBig.textContent = String(score);
  ovSub.textContent = "Score final";

  return { score, avgEff: Math.round(avgEff), peakEff: Math.round(peakEff) };
}

/* ========= CONFETTI ========= */
const confettiCanvas = document.getElementById('confetti');
const ctx = confettiCanvas.getContext('2d');
let confetti = [];
function resizeCanvas(){
  confettiCanvas.width = window.innerWidth * devicePixelRatio;
  confettiCanvas.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let confettiAnim = null;
function burstConfetti(){
  const W = window.innerWidth, H = window.innerHeight;
  confetti = [];
  const n = 220;

  const palette = [
    {h: 190, s: 95, l: 60},
    {h: 260, s: 95, l: 65},
    {h: 315, s: 95, l: 62},
    {h: 340, s: 95, l: 60}
  ];

  for (let i=0;i<n;i++){
    const c = palette[Math.floor(Math.random()*palette.length)];
    confetti.push({
      x: W/2 + (Math.random()-0.5)*180,
      y: H*0.28 + (Math.random()-0.5)*80,
      vx: (Math.random()-0.5)*12,
      vy: - (Math.random()*10 + 6),
      g: 0.25 + Math.random()*0.20,
      r: 2 + Math.random()*5,
      a: 1,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.30,
      color: `hsl(${c.h} ${c.s}% ${c.l}%)`
    });
  }
  animateConfetti();
}
function animateConfetti(){
  if (confettiAnim) cancelAnimationFrame(confettiAnim);
  const W = window.innerWidth, H = window.innerHeight;

  function step(){
    ctx.clearRect(0,0,W,H);
    let alive = 0;

    for (const p of confetti){
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.rot += p.vr;
      p.a -= 0.006;

      if (p.a > 0 && p.y < H + 60){
        alive++;
        ctx.save();
        ctx.globalAlpha = Math.max(0, p.a);
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.r, -p.r, p.r*2.6, p.r*1.2);
        ctx.restore();
      }
    }
    if (alive > 0) confettiAnim = requestAnimationFrame(step);
    else { ctx.clearRect(0,0,W,H); confettiAnim = null; }
  }
  step();
}

/* ========= TEAMS (2 par d√©faut + ajout illimit√©) ========= */
let teamCounter = 0;
const teams = []; // {id, name, score, avg, peak, els...}

function makeTeamId(){
  // T1, T2, T3... (sans limites, pas de soucis A/B/Z)
  teamCounter += 1;
  return `T${teamCounter}`;
}

function createTeamCard(team){
  const el = document.createElement('div');
  el.className = 'team';
  el.innerHTML = `
    <div class="teamHeader">
      <div class="teamName" data-team-name="${team.id}">${escapeHtml(team.name)}</div>
      <div class="teamTag">Score : <span id="mini-${team.id}">0</span></div>
    </div>

    <div class="meter">
      <div class="fill" id="fill-${team.id}"></div>
      <div class="shine"></div>
      <div class="scanline"></div>
    </div>

    <div class="bigScore"><span id="score-${team.id}">0</span></div>

    <div class="miniRow">
      <span class="pill">Pic: <span id="peak-${team.id}">0</span></span>
      <span class="pill">Moy.: <span id="avg-${team.id}">0</span></span>
    </div>

    <div class="nameRow">
      <button data-run data-team="${team.id}">Lancer</button>
      <input class="nameInput" data-name="${team.id}" type="text" value="${escapeAttr(team.name)}" />
    </div>
  `;

  team.els = {
    root: el,
    nameLabel: el.querySelector(`[data-team-name="${team.id}"]`),
    runBtn: el.querySelector(`[data-team="${team.id}"]`),
    nameInput: el.querySelector(`[data-name="${team.id}"]`),
    fill: el.querySelector(`#fill-${team.id}`),
    score: el.querySelector(`#score-${team.id}`),
    mini: el.querySelector(`#mini-${team.id}`),
    peak: el.querySelector(`#peak-${team.id}`),
    avg: el.querySelector(`#avg-${team.id}`)
  };

  // rename
  team.els.nameInput.addEventListener('input', (e) => {
    const v = (e.target.value || '').trim();
    team.name = v.length ? v : '√âquipe';
    team.els.nameLabel.textContent = team.name;
  });

  // run
  team.els.runBtn.addEventListener('click', () => runTeam(team.id));

  return el;
}

function addTeam(name){
  const id = makeTeamId();
  const team = { id, name: name || `√âquipe ${teams.length + 1}`, score: 0, avg: 0, peak: 0, els: null };
  teams.push(team);
  teamsGrid.appendChild(createTeamCard(team));
  updateResultText();
}

function updateResultText(){
  const played = teams.filter(t => t.score > 0);
  if (played.length === 0) {
    resultText.textContent = "Pr√™t ‚Äî lance une √©quipe.";
    return;
  }
  if (played.length === 1) {
    resultText.textContent = `${played[0].name} enregistr√©e. Lance une autre √©quipe !`;
    return;
  }

  const sorted = [...played].sort((a,b) => b.score - a.score);
  const best = sorted[0];
  const second = sorted[1];

  if (best.score === second.score) {
    resultText.textContent = `ü§ù √âgalit√© en t√™te √† ${best.score} !`;
    burstConfetti();
    return;
  }

  resultText.textContent = `üèÜ Victoire ${best.name} (${best.score}) !`;
  burstConfetti();
}

async function runTeam(teamId){
  const team = teams.find(t => t.id === teamId);
  if (!team) return;

  try{
    if (!running) await startAudio();

    lockRunButtons(true);
    stateEl.textContent = `Mesure ${team.name}‚Ä¶`;

    await countdown(team.name);
    const res = await measureLive(team.els.fill);

    team.score = res.score;
    team.avg = res.avgEff;
    team.peak = res.peakEff;

    team.els.score.textContent = String(team.score);
    team.els.mini.textContent = String(team.score);
    team.els.avg.textContent = String(team.avg);
    team.els.peak.textContent = String(team.peak);

    stateEl.textContent = "Termin√©";
    ovTitle.textContent = "Score final";
    ovTeam.textContent = team.name;
    ovSub.textContent = "Bravo !";
    await sleep(900);
    hideOverlay();

    updateResultText();

  } catch(err){
    alert("Micro refus√© ou indisponible : " + err);
    stateEl.textContent = "Erreur micro";
    hideOverlay();
    stopAudio();
  } finally {
    lockRunButtons(false);
  }
}

/* ========= utils ========= */
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
function escapeAttr(s){
  return escapeHtml(s).replaceAll('\n',' ');
}

/* ========= buttons ========= */
addTeamBtn.addEventListener('click', () => addTeam(`√âquipe ${teams.length + 1}`));

fullscreenBtn.addEventListener('click', () => {
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
});

stopBtn.addEventListener('click', () => stopAudio());

calibBtn.addEventListener('click', async () => {
  try {
    await calibrate2s();
  } catch (err) {
    alert("Micro refus√© ou indisponible : " + err);
    hideOverlay();
    stopAudio();
  }
});

/* ========= init (2 √©quipes par d√©faut) ========= */
addTeam("√âquipe A");
addTeam("√âquipe B");
</script>
</body>
</html>
